<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferrule Designer Pro | Precision Manufacturing</title>
    <!-- html2canvas for capturing the ferrule visual -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: #111; color: #eee; min-height: 100vh;
            display: flex; justify-content: center; align-items: center; padding: 15px;
        }
        #lock-screen {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #lock-screen input { padding: 15px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; text-align: center; margin-bottom: 20px; font-size: 1.2rem; }
        
        .container {
            width: 100%; max-width: 1400px; height: 95vh;
            background: #222; border-radius: 12px;
            display: none; grid-template-columns: 460px 1fr;
            overflow: hidden; border: 1px solid #333;
        }
        
        .sidebar { padding: 20px; background: #2a2a2a; border-right: 1px solid #333; overflow-y: auto; }
        h2 { font-size: 0.85rem; margin-bottom: 12px; color: #f1c40f; text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        
        .metallic-palette {
            background: #1a1a1a; padding: 15px; border-radius: 8px; 
            margin-bottom: 20px; border: 1px solid #444;
        }
        .m-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .m-swatch { 
            height: 42px; border-radius: 4px; cursor: pointer; border: 2px solid #333; 
            display: flex; align-items: center; justify-content: center; font-size: 0.55rem; font-weight: bold;
            transition: all 0.2s; text-align: center; position: relative;
        }
        .m-swatch:hover { transform: scale(1.08); border-color: #f1c40f; box-shadow: 0 0 15px rgba(241, 196, 15, 0.3); z-index: 10; }
        .m-swatch:active { transform: scale(0.95); }

        .quick-actions {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px;
        }
        .quick-btn {
            padding: 8px; background: #333; border: 1px solid #444; border-radius: 6px;
            cursor: pointer; font-size: 0.7rem; text-transform: uppercase; font-weight: bold;
            transition: 0.2s; color: #aaa; text-align: center;
        }
        .quick-btn:hover { background: #444; color: #f1c40f; border-color: #f1c40f; }

        #sectionControls { max-height: 400px; overflow-y: auto; padding-right: 10px; margin-bottom: 20px; }
        .section-row { 
            display: flex; align-items: center; gap: 8px; margin-bottom: 6px; 
            background: #333; padding: 6px; border-radius: 4px; border: 1px solid transparent;
            transition: 0.2s;
        }
        .section-row:hover { background: #3a3a3a; border-color: #555; }
        .section-row.selected { border-color: #f1c40f; background: #3a3a3a; }
        .section-row input[type="color"] { width: 35px; height: 35px; border: none; cursor: pointer; background: none; border-radius: 4px; }
        .section-row input[type="text"] { 
            width: 85px; padding: 6px; background: #111; border: 1px solid #444; 
            color: #fff; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.8rem;
        }
        .section-row input[type="text"]:focus { border-color: #f1c40f; outline: none; }
        .pantone-tag { 
            flex: 1; font-size: 0.65rem; color: #bbb; text-align: right; 
            overflow: hidden; white-space: nowrap; font-weight: 500;
        }
        .pantone-tag.exact { color: #2ecc71; }
        .pantone-tag.close { color: #f39c12; }
        .pantone-tag.approx { color: #e74c3c; }

        .dim-controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .dim-box { background: #1a1a1a; padding: 10px; border-radius: 6px; border: 1px solid #444; }
        .dim-box label { font-size: 0.6rem; color: #888; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .dim-box input { width: 100%; padding: 6px; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px; font-size: 0.9rem; }
        .dim-box input:focus { border-color: #f1c40f; outline: none; }

        .viewport { 
            background: radial-gradient(circle, #2a2a2a 0%, #050505 100%); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; position: relative; 
        }
        .ferrule-viz { 
            width: 320px; height: 480px; display: flex; flex-direction: column; 
            transition: clip-path 0.4s ease; box-shadow: 0 0 50px rgba(0,0,0,0.5);
            cursor: pointer;
        }
        .sec-slice { 
            flex: 1; width: 100%; border-bottom: 0.1px solid rgba(255,255,255,0.02); 
            cursor: pointer; transition: opacity 0.2s;
        }
        .sec-slice:hover { opacity: 0.8; }
        .sec-slice.selected { outline: 2px solid #f1c40f; outline-offset: -2px; z-index: 100; }
        
        .spec-footer { 
            position: absolute; bottom: 20px; width: 90%; background: rgba(0,0,0,0.85); 
            padding: 15px; border-radius: 8px; border: 1px solid #444; display: flex; justify-content: space-between; align-items: center;
        }
        .sku-val { font-family: 'Courier New', monospace; font-size: 1.5rem; color: #f1c40f; font-weight: bold; }
        
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-transform: uppercase; margin-top: 10px; width: 100%; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .btn-save { background: #27ae60; color: #fff; }
        .btn-save:hover { background: #2ecc71; }
        .btn-reset { background: #444; color: #aaa; margin-top: 5px; }
        .btn-reset:hover { background: #555; color: #fff; }

        .tooltip {
            position: absolute; background: rgba(0,0,0,0.95); color: #fff; padding: 8px 12px;
            border-radius: 6px; font-size: 0.75rem; pointer-events: none; z-index: 1000;
            border: 1px solid #f1c40f; display: none; white-space: nowrap;
        }

        .notification {
            position: fixed; top: 20px; right: 20px; background: #27ae60; color: #fff;
            padding: 12px 20px; border-radius: 6px; font-weight: bold; z-index: 9999;
            animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s forwards;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h1 style="margin-bottom:20px; letter-spacing:4px; color:#f1c40f;">SECURE ACCESS</h1>
        <input type="password" id="pw" placeholder="Enter Password">
        <button class="btn" onclick="unlock()" style="width:220px; background:#fff; color:#000;">Authorize</button>
        <p style="margin-top:10px; color:#666; font-size:0.8rem;">Hint: 4-letter sport</p>
    </div>

    <div class="container" id="app">
        <div class="sidebar">
            <div class="metallic-palette">
                <h2>Metallic Reference Box</h2>
                <div class="m-grid">
                    <div class="m-swatch" style="background:#84754e; color:#fff;" data-hex="#84754E" title="Click to apply">871 C<br>GOLD</div>
                    <div class="m-swatch" style="background:#a68966; color:#fff;" data-hex="#A68966" title="Click to apply">872 C<br>RICH</div>
                    <div class="m-swatch" style="background:#8a8d8f; color:#000;" data-hex="#8A8D8F" title="Click to apply">877 C<br>SILVER</div>
                    <div class="m-swatch" style="background:#d5d2d1; color:#000;" data-hex="#D5D2D1" title="Click to apply">8001 C<br>PLAT</div>
                    <div class="m-swatch" style="background:#915520; color:#fff;" data-hex="#915520" title="Click to apply">876 C<br>COPPER</div>
                    <div class="m-swatch" style="background:#54585a; color:#fff;" data-hex="#54585A" title="Click to apply">8003 C<br>GUN</div>
                    <div class="m-swatch" style="background:#7a6a4f; color:#fff;" data-hex="#7A6A4F" title="Click to apply">873 C<br>BRONZE</div>
                    <div class="m-swatch" style="background:#81d8d0; color:#000;" data-hex="#81D8D0" title="Click to apply">TIFFANY<br>BLUE</div>
                </div>
            </div>

            <div class="quick-actions">
                <div class="quick-btn" onclick="applyPattern('gradient')">Gradient Fill</div>
                <div class="quick-btn" onclick="applyPattern('alternate')">Alternating</div>
                <div class="quick-btn" onclick="applyPattern('triple')">Triple Stripe</div>
                <div class="quick-btn" onclick="copyAllColors()">Copy All Hex</div>
            </div>

            <h2>Section Color Configuration</h2>
            <div id="sectionControls"></div>
            
            <h2>Manufacturing Geometry</h2>
            <div class="dim-controls">
                <div class="dim-box"><label>Length (mm)</label><input type="number" id="len" value="25" min="10" max="50"></div>
                <div class="dim-box"><label>Internal Ã˜ (mm)</label><input type="number" id="wall" value="8.5" step="0.1" min="5" max="20"></div>
                <div class="dim-box"><label>Top Ã˜ (mm)</label><input type="number" id="topD" value="10.5" step="0.1" min="5" max="20"></div>
                <div class="dim-box"><label>Bottom Ã˜ (mm)</label><input type="number" id="botD" value="14.5" step="0.1" min="5" max="25"></div>
            </div>
            
            <button class="btn btn-save" onclick="downloadPDF()">ðŸ“¥ Download Production PDF</button>
            <button class="btn btn-reset" onclick="resetDesigner()">ðŸ”„ Reset Designer</button>
        </div>
        
        <div class="viewport">
            <div class="ferrule-viz" id="preview"></div>
            
            <div class="spec-footer">
                <div>
                    <div style="font-size: 0.6rem; color: #888;">BUILD SKU</div>
                    <div id="skuDisplay" class="sku-val">F-25-XXXX</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.6rem; color: #888;">SECTIONS</div>
                    <div style="font-weight: bold; color:#fff;">20 Layers</div>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        const TOTAL_SECS = 20;
        let activeColors = Array(TOTAL_SECS).fill('#000000');
        let currentID = "";
        let selectedSection = null;

        const PANTONE_DB = {
            '#84754e': { name: '871 C', desc: 'Gold', category: 'metallic' },
            '#a68966': { name: '872 C', desc: 'Rich Gold', category: 'metallic' },
            '#7a6a4f': { name: '873 C', desc: 'Bronze Gold', category: 'metallic' },
            '#74622e': { name: '874 C', desc: 'Antique Gold', category: 'metallic' },
            '#8a8d8f': { name: '877 C', desc: 'Silver', category: 'metallic' },
            '#b1b3b3': { name: '877 C Light', desc: 'Light Silver', category: 'metallic' },
            '#915520': { name: '876 C', desc: 'Copper', category: 'metallic' },
            '#be8a5f': { name: '729 C', desc: 'Light Copper', category: 'metallic' },
            '#54585a': { name: '8003 C', desc: 'Gunmetal', category: 'metallic' },
            '#d5d2d1': { name: '8001 C', desc: 'Platinum', category: 'metallic' },
            '#c0b8b0': { name: '8002 C', desc: 'Warm Silver', category: 'metallic' },
            '#b4975a': { name: '7502 C', desc: 'Old Gold', category: 'metallic' },
            '#81d8d0': { name: '1837 C', desc: 'Tiffany Blue', category: 'blue' },
            '#0077c8': { name: '307 C', desc: 'Process Blue', category: 'blue' },
            '#003087': { name: '294 C', desc: 'Royal Blue', category: 'blue' },
            '#002855': { name: '289 C', desc: 'Navy Blue', category: 'blue' },
            '#00205b': { name: '295 C', desc: 'Dark Navy', category: 'blue' },
            '#006747': { name: '3425 C', desc: 'Masters Green', category: 'green' },
            '#009639': { name: '355 C', desc: 'Kelly Green', category: 'green' },
            '#c8102e': { name: '186 C', desc: 'Titleist Red', category: 'red' },
            '#ed174e': { name: '192 C', desc: 'Cardinal', category: 'red' },
            '#9d2235': { name: '201 C', desc: 'Burgundy', category: 'red' },
            '#ff6900': { name: '165 C', desc: 'Orange', category: 'orange' },
            '#ffb81c': { name: '1235 C', desc: 'Yellow', category: 'yellow' },
            '#6f2c91': { name: '259 C', desc: 'Purple', category: 'purple' },
            '#ffffff': { name: 'White', desc: 'Pure White', category: 'neutral' },
            '#000000': { name: 'Black C', desc: 'Pure Black', category: 'neutral' },
            '#a7a9ac': { name: 'Cool Gray 5 C', desc: 'Medium Gray', category: 'neutral' },
            '#53565a': { name: 'Cool Gray 10 C', desc: 'Dark Gray', category: 'neutral' }
        };

        function unlock() {
            if(document.getElementById('pw').value.toLowerCase() === 'golf') {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('app').style.display = 'grid';
                initDesigner();
                showNotification('âœ“ Access Granted');
            } else {
                showNotification('âœ— Invalid Password', '#e74c3c');
            }
        }

        function showNotification(msg, color = '#27ae60') {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = msg;
            notif.style.background = color;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function copyHex(hex) {
            navigator.clipboard.writeText(hex);
            showNotification(`âœ“ Copied ${hex}`);
        }

        function getSKU() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let res = '';
            for (let i = 0; i < 4; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
            return res;
        }

        function getColorCategory(r, g, b) {
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const diff = max - min;
            if(diff < 15) return 'neutral';
            if(r > g && r > b) { if(g > b * 1.5) return 'orange'; return 'red'; }
            else if(g > r && g > b) { if(b > r * 1.3) return 'blue'; return 'green'; }
            else if(b > r && b > g) { if(r > g * 1.2) return 'purple'; return 'blue'; }
            return 'neutral';
        }

        function findPantone(hex) {
            hex = hex.toLowerCase().trim();
            if(!hex.startsWith('#')) hex = '#' + hex;
            for(let key in PANTONE_DB) {
                if(key.toLowerCase() === hex) {
                    return { text: `${PANTONE_DB[key].name} (${PANTONE_DB[key].desc})`, quality: 'exact', distance: 0 };
                }
            }
            const r1 = parseInt(hex.substring(1,3), 16);
            const g1 = parseInt(hex.substring(3,5), 16);
            const b1 = parseInt(hex.substring(5,7), 16);
            const inputCategory = getColorCategory(r1, g1, b1);
            let bestMatch = null;
            let minDistance = Infinity;
            for(let key in PANTONE_DB) {
                const normalizedKey = key.toLowerCase();
                const r2 = parseInt(normalizedKey.substring(1,3), 16);
                const g2 = parseInt(normalizedKey.substring(3,5), 16);
                const b2 = parseInt(normalizedKey.substring(5,7), 16);
                const colorDistance = Math.sqrt(Math.pow(r1-r2,2)+Math.pow(g1-g2,2)+Math.pow(b1-b2,2));
                let distance = colorDistance;
                const pantoneCategory = PANTONE_DB[key].category;
                if(inputCategory !== 'neutral' && pantoneCategory !== inputCategory && pantoneCategory !== 'neutral' && pantoneCategory !== 'metallic') {
                    distance *= 1.8;
                }
                if(distance < minDistance) { minDistance = distance; bestMatch = PANTONE_DB[key]; }
            }
            let quality = 'approx';
            if(minDistance < 30) quality = 'exact';
            else if(minDistance < 80) quality = 'close';
            return {
                text: `${bestMatch.name} (${bestMatch.desc})${quality === 'approx' ? ' ~' : ''}`,
                quality: quality,
                distance: minDistance
            };
        }

        function refreshPreview() {
            if(!currentID) currentID = getSKU();
            const L = document.getElementById('len').value;
            const T = parseFloat(document.getElementById('topD').value);
            const B = parseFloat(document.getElementById('botD').value);
            document.getElementById('skuDisplay').innerText = `F-${L}-${currentID}`;
            const viz = document.getElementById('preview');
            const max = Math.max(T, B);
            const topP = ((T / max) * 100) / 2;
            const botP = ((B / max) * 100) / 2;
            viz.style.clipPath = `polygon(${50-topP}% 0%, ${50+topP}% 0%, ${50+botP}% 100%, ${50-botP}% 100%)`;
            viz.innerHTML = '';
            activeColors.forEach((c, idx) => {
                const s = document.createElement('div');
                s.className = 'sec-slice';
                if(selectedSection === idx) s.classList.add('selected');
                s.style.background = c;
                s.onclick = () => selectSection(idx);
                viz.appendChild(s);
            });
        }

        function selectSection(index) {
            selectedSection = index;
            document.querySelectorAll('.section-row').forEach((row, i) => {
                row.classList.toggle('selected', i === index);
            });
            refreshPreview();
        }

        function updateSection(index, hex) {
            if(!hex.startsWith('#')) hex = '#' + hex;
            if(/^#[0-9A-F]{6}$/i.test(hex)) {
                activeColors[index] = hex;
                document.getElementById(`p${index}`).value = hex;
                document.getElementById(`h${index}`).value = hex.toUpperCase();
                const match = findPantone(hex);
                const tag = document.getElementById(`tag${index}`);
                tag.innerText = match.text;
                tag.className = `pantone-tag ${match.quality}`;
                currentID = getSKU();
                refreshPreview();
            }
        }

        function applyPattern(type) {
            if(selectedSection === null) { showNotification('âš  Select a section first', '#f39c12'); return; }
            const baseColor = activeColors[selectedSection];
            if(type === 'gradient') {
                for(let i = 0; i < TOTAL_SECS; i++) {
                    const ratio = i / (TOTAL_SECS - 1);
                    const r = Math.round(parseInt(baseColor.substring(1,3), 16) * (1 - ratio));
                    const g = Math.round(parseInt(baseColor.substring(3,5), 16) * (1 - ratio));
                    const b = Math.round(parseInt(baseColor.substring(5,7), 16) * (1 - ratio));
                    updateSection(i, `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`);
                }
            } else if(type === 'alternate') {
                const color2 = activeColors[(selectedSection + 1) % TOTAL_SECS];
                for(let i = 0; i < TOTAL_SECS; i++) { updateSection(i, i % 2 === 0 ? baseColor : color2); }
            } else if(type === 'triple') {
                const color2 = activeColors[(selectedSection + 5) % TOTAL_SECS];
                const color3 = activeColors[(selectedSection + 10) % TOTAL_SECS];
                for(let i = 0; i < TOTAL_SECS; i++) {
                    const colorIndex = i % 3;
                    updateSection(i, colorIndex === 0 ? baseColor : colorIndex === 1 ? color2 : color3);
                }
            }
            showNotification(`âœ“ ${type} pattern applied`);
        }

        function copyAllColors() {
            const hexList = activeColors.map((c, i) => `S${i+1}: ${c}`).join('\n');
            navigator.clipboard.writeText(hexList);
            showNotification('âœ“ All hex codes copied');
        }

        function initDesigner() {
            const ctrl = document.getElementById('sectionControls');
            ctrl.innerHTML = '';
            for(let i=0; i<TOTAL_SECS; i++) {
                const row = document.createElement('div');
                row.className = 'section-row';
                row.innerHTML = `
                    <label style="font-size:0.55rem; width:15px; color:#777; font-weight:bold;">${i+1}</label>
                    <input type="color" id="p${i}" value="${activeColors[i]}">
                    <input type="text" id="h${i}" value="${activeColors[i].toUpperCase()}" maxlength="7" placeholder="#000000">
                    <span class="pantone-tag" id="tag${i}"></span>
                `;
                ctrl.appendChild(row);
                const picker = row.querySelector(`#p${i}`);
                const hexIn = row.querySelector(`#h${i}`);
                picker.addEventListener('input', (e) => updateSection(i, e.target.value));
                hexIn.addEventListener('input', (e) => updateSection(i, e.target.value));
                row.addEventListener('click', (e) => { if(e.target.tagName !== 'INPUT') selectSection(i); });
                const match = findPantone(activeColors[i]);
                const tag = document.getElementById(`tag${i}`);
                tag.innerText = match.text;
                tag.className = `pantone-tag ${match.quality}`;
            }
            document.querySelectorAll('.m-swatch').forEach(swatch => {
                swatch.addEventListener('click', () => {
                    const hex = swatch.getAttribute('data-hex');
                    if(selectedSection !== null) { updateSection(selectedSection, hex); showNotification(`âœ“ Applied to Section ${selectedSection + 1}`); }
                    else { copyHex(hex); }
                });
            });
            refreshPreview();
        }

        // â”€â”€â”€ PDF EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function downloadPDF() {
            showNotification('â³ Generating PDF...', '#2980b9');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

            const sku    = document.getElementById('skuDisplay').innerText;
            const L      = document.getElementById('len').value;
            const T      = document.getElementById('topD').value;
            const B      = document.getElementById('botD').value;
            const ID     = document.getElementById('wall').value;
            const dateStr = new Date().toLocaleString();

            // â”€â”€ Page dimensions
            const pw = doc.internal.pageSize.getWidth();   // 210
            const ph = doc.internal.pageSize.getHeight();  // 297

            // â”€â”€ Dark header bar
            doc.setFillColor(17, 17, 17);
            doc.rect(0, 0, pw, 28, 'F');

            // â”€â”€ Gold accent line
            doc.setFillColor(241, 196, 15);
            doc.rect(0, 27, pw, 1.5, 'F');

            // â”€â”€ Company / title text
            doc.setTextColor(241, 196, 15);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('FERRULE PRODUCTION SPECIFICATION', pw / 2, 11, { align: 'center' });

            doc.setTextColor(180, 180, 180);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(`SKU: ${sku}   |   Generated: ${dateStr}`, pw / 2, 19, { align: 'center' });

            // â”€â”€ Geometry block (left column)
            const col1x = 14;
            let y = 38;
            doc.setFillColor(34, 34, 34);
            doc.roundedRect(col1x, y - 5, 80, 40, 2, 2, 'F');

            doc.setTextColor(241, 196, 15);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('MANUFACTURING GEOMETRY', col1x + 4, y);
            y += 6;

            const geomRows = [
                ['Length', `${L} mm`],
                ['Top Diameter (Ã˜)', `${T} mm`],
                ['Bottom Diameter (Ã˜)', `${B} mm`],
                ['Internal Diameter (Ã˜)', `${ID} mm`],
            ];
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8.5);
            geomRows.forEach(([label, val]) => {
                doc.setTextColor(160, 160, 160);
                doc.text(label, col1x + 4, y);
                doc.setTextColor(255, 255, 255);
                doc.text(val, col1x + 4 + 46, y);
                y += 7;
            });

            // â”€â”€ Capture the ferrule visual using html2canvas
            let ferruleImgData = null;
            try {
                const vizEl = document.getElementById('preview');
                const canvas = await html2canvas(vizEl, {
                    backgroundColor: '#050505',
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                ferruleImgData = canvas.toDataURL('image/png');
            } catch(e) {
                console.warn('html2canvas failed:', e);
            }

            // â”€â”€ Ferrule image (right column)
            if (ferruleImgData) {
                const imgX = pw - 14 - 60;
                const imgY = 33;
                const imgW = 60;
                const imgH = 90;

                // Dark backdrop
                doc.setFillColor(5, 5, 5);
                doc.roundedRect(imgX - 3, imgY - 3, imgW + 6, imgH + 6, 2, 2, 'F');
                doc.setDrawColor(60, 60, 60);
                doc.setLineWidth(0.4);
                doc.roundedRect(imgX - 3, imgY - 3, imgW + 6, imgH + 6, 2, 2, 'S');

                doc.addImage(ferruleImgData, 'PNG', imgX, imgY, imgW, imgH);

                doc.setTextColor(100, 100, 100);
                doc.setFontSize(6.5);
                doc.setFont('helvetica', 'italic');
                doc.text('Design Preview', imgX + imgW / 2, imgY + imgH + 5, { align: 'center' });
            }

            // â”€â”€ Color Sequence Table
            const tableStartY = 135;
            const tableX = col1x;
            const tableW = pw - 28;

            // Header
            doc.setFillColor(25, 25, 25);
            doc.rect(tableX, tableStartY, tableW, 7, 'F');
            doc.setFillColor(241, 196, 15);
            doc.rect(tableX, tableStartY + 7, tableW, 0.6, 'F');

            doc.setTextColor(241, 196, 15);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('COLOR SEQUENCE (Top â†’ Bottom)', tableX + 3, tableStartY + 5);

            const colWidths = [12, 28, 70, 30, 26];  // Sec, Swatch, Pantone, Hex, Quality
            const colHeaders = ['SEC', 'COLOR', 'PANTONE MATCH', 'HEX CODE', 'QUALITY'];
            const colX = [tableX + 2, tableX + 14, tableX + 44, tableX + 116, tableX + 148];

            let ty = tableStartY + 12;

            // Column headers
            doc.setFillColor(40, 40, 40);
            doc.rect(tableX, ty - 4, tableW, 6, 'F');
            doc.setTextColor(180, 180, 180);
            doc.setFontSize(6.5);
            doc.setFont('helvetica', 'bold');
            colHeaders.forEach((h, i) => doc.text(h, colX[i], ty));
            ty += 4;

            // Rows
            doc.setFont('helvetica', 'normal');
            activeColors.forEach((hex, idx) => {
                const match = findPantone(hex);
                const rowH = 5.5;
                const bg = idx % 2 === 0 ? [28, 28, 28] : [22, 22, 22];
                doc.setFillColor(...bg);
                doc.rect(tableX, ty - 3.5, tableW, rowH, 'F');

                // Section number
                doc.setTextColor(120, 120, 120);
                doc.setFontSize(6);
                doc.text(String(idx + 1).padStart(2, '0'), colX[0], ty);

                // Color swatch box
                const rgb = [
                    parseInt(hex.substring(1,3), 16),
                    parseInt(hex.substring(3,5), 16),
                    parseInt(hex.substring(5,7), 16)
                ];
                doc.setFillColor(...rgb);
                doc.roundedRect(colX[1], ty - 3, 8, 4, 0.5, 0.5, 'F');
                doc.setDrawColor(60, 60, 60);
                doc.setLineWidth(0.2);
                doc.roundedRect(colX[1], ty - 3, 8, 4, 0.5, 0.5, 'S');

                // Pantone name
                doc.setTextColor(220, 220, 220);
                doc.setFontSize(6);
                doc.text(match.text.substring(0, 42), colX[2], ty);

                // Hex code
                doc.setTextColor(180, 180, 180);
                doc.setFont('courier', 'normal');
                doc.text(hex.toUpperCase(), colX[3], ty);

                // Quality badge
                const qColors = { exact: [46, 204, 113], close: [243, 156, 18], approx: [231, 76, 60] };
                const qc = qColors[match.quality] || [150, 150, 150];
                doc.setFillColor(...qc);
                doc.roundedRect(colX[4], ty - 3.2, 16, 4, 1, 1, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(5.5);
                doc.text(match.quality.toUpperCase(), colX[4] + 8, ty, { align: 'center' });

                doc.setFont('helvetica', 'normal');
                ty += rowH;
            });

            // â”€â”€ Footer
            const footerY = ph - 14;
            doc.setFillColor(17, 17, 17);
            doc.rect(0, footerY - 4, pw, 18, 'F');
            doc.setFillColor(241, 196, 15);
            doc.rect(0, footerY - 4, pw, 0.8, 'F');

            doc.setTextColor(100, 100, 100);
            doc.setFontSize(6.5);
            doc.setFont('helvetica', 'normal');
            doc.text('Match quality: EXACT (perfect match) Â· CLOSE (within tolerance) Â· APPROX (approximate)', pw / 2, footerY + 2, { align: 'center' });
            doc.text('Verify physical colour samples before production run Â· Contact supplier with this document for approval', pw / 2, footerY + 7, { align: 'center' });

            // â”€â”€ Save
            doc.save(`Ferrule-Spec-${sku}.pdf`);
            showNotification('âœ“ PDF downloaded!');
        }

        function resetDesigner() {
            if(confirm('Reset all colors and settings?')) {
                activeColors = Array(TOTAL_SECS).fill('#000000');
                selectedSection = null;
                currentID = getSKU();
                document.querySelectorAll('.section-row').forEach((row, i) => { updateSection(i, '#000000'); });
                refreshPreview();
                showNotification('âœ“ Designer reset');
            }
        }

        ['len', 'topD', 'botD', 'wall'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => { currentID = getSKU(); refreshPreview(); });
        });

        document.addEventListener('keydown', (e) => {
            if(e.key === 'ArrowUp' && selectedSection !== null && selectedSection > 0) { e.preventDefault(); selectSection(selectedSection - 1); }
            else if(e.key === 'ArrowDown' && selectedSection !== null && selectedSection < TOTAL_SECS - 1) { e.preventDefault(); selectSection(selectedSection + 1); }
        });

        document.getElementById('pw').addEventListener('keypress', (e) => { if(e.key === 'Enter') unlock(); });
    </script>
</body>
</html>
